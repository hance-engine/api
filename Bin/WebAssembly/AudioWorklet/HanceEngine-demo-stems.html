<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Minimal Audio Worklet example</title>
</head>

<body>
<script>

var Module = {
    setStatus: (text) => {
         if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
         if (text === Module.setStatus.last.text) return;
         var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
         var now = Date.now();
         if (m && now - Module.setStatus.last.time < 30) return;
         Module.setStatus.last.time = now;
         Module.setStatus.last.text = text;
         console.log(text);
     }
};

Module.onRuntimeInitialized = function() {
    console.log("Engine fully loaded");
    document.getElementById("loadengine").innerHTML = "&#10004;";
    addLicenses();
}

// LOAD HANCE MODEL
async function getModel(modelKey) {
    const response = await fetch("Models/" + modelKey);
    const arrayBuffer = await response.arrayBuffer();
    console.log("Model loaded: " + modelKey);
    document.getElementById("loadmodel").innerHTML = "&#10004;";
    transferModelToHanceEngine(arrayBuffer);
}

let numberOfStems = 0;

function transferModelToHanceEngine(arrayBuffer) {
    const byteArray = new Uint8Array(arrayBuffer);
    const length = byteArray.length;
    const ptr = Module._malloc(length);
    Module.HEAPU8.set(byteArray, ptr);
    Module._loadModelForStem(numberOfStems, ptr, length);
    numberOfStems += 1
    Module._free(ptr);
    console.log("Model transferred to engine");
    document.getElementById("transfermodel").innerHTML = "&#10004;";
    console.log("Number of stems ", numberOfStems);
}

var soundRequest = new XMLHttpRequest();
var example = {};
function loadExample(soundFile, modelIndex){
    stop();

    console.log("Loading Example:", soundFile);
    document.getElementById("loadexample").innerHTML = "&#x1F550;";
    document.getElementById("loadmodel").innerHTML = "&#x1F550;";
    document.getElementById("transfermodel").innerHTML = "&#x1F550;";
    document.getElementById("playbutton").disabled = true; 

    // First load the corresponding models
    numberOfStems = 0;
    getModel(modelKeys[0]);
    getModel(modelKeys[1]);
    getModel(modelKeys[2]);
    getModel(modelKeys[3]).then(() => {
        // Then load the sound
        soundRequest.open("GET", soundFile, true);
        soundRequest.responseType = "arraybuffer";
        soundRequest.onload = function() {
            audioContext.decodeAudioData(soundRequest.response, function(buffer){
                example.buffer = buffer;
                console.log("Length of sound", buffer.duration);
                document.getElementById("loadexample").innerHTML = "&#10004;"; 
                document.getElementById("playbutton").disabled = false; 
            });
        }
        soundRequest.send();
    });
}
function playExample(){
    if (!example.buffer) {
        console.log("No example loaded.");
        return;
    }
    document.getElementById("playbutton").disabled = true; 
    document.getElementById("stopbutton").disabled = false; 

    // Ensure audioContext is running
    if (audioContext.state === 'suspended') {
        audioContext.resume().then(() => {
            startPlayback();
        });
    } else {
        startPlayback();
    }
}

let currentChannel = 0;

function startPlayback() {
    example.sound = audioContext.createBufferSource();
    example.sound.buffer = example.buffer;
    Module._resetEngine();
    example.sound.connect(audioWorkletNode);
    connectToCurrentChannel();
    example.sound.start();
    example.sound.onended = function() {
        stop();
    }
}

function connectToCurrentChannel() {
    if (example.sound) {
        audioWorkletNode.connect(audioContext.destination, currentChannel);
    }
    document.getElementById("stemNum").innerText = "Stem " + currentChannel.toString();
}

function connectToNextChannel() {
    audioWorkletNode.disconnect();
    currentChannel += 1;
    if (currentChannel >= numberOfStems)
        currentChannel = 0;
    connectToCurrentChannel();
}

function attenuationForStem(stemNum, value){
    console.log("Set attenuation for stem", stemNum, ":", value);
    Module._setParameterValueForStem(stemNum, 1, value);
}

function stop(){
    document.getElementById("playbutton").disabled = false; 
    document.getElementById("stopbutton").disabled = true; 
    if (example.sound) {
        example.sound.stop();
        example.sound.disconnect();
        example.sound = null;
    }
    if (audioWorkletNode) {
        audioWorkletNode.disconnect();
    }
}

function addLicenses() {
    modelKeys
        .map(getLicense)
        .filter(licenseKey => licenseKey)
        .forEach(transferLicenseToHanceEngine);
    console.log("All licenses added");
    document.getElementById("addlicense").innerHTML = "&#10004;";
}
function getLicense(modelKey) {
    const licenseMap = {
        "vocals_separation.hance": "",
        "drums_separation.hance": "",
        "piano_separation.hance": "",
        "bass_separation.hance": "",
    };
    return licenseMap[modelKey] || "";
}   

function transferLicenseToHanceEngine(licenseKey) {
    const ptr = Module.stringToNewUTF8(licenseKey);
    Module._addLicense(ptr);
    Module._free(ptr);
}   
// Define modelKeys globally so it's accessible in other functions
const modelKeys = ["vocals_separation.hance",
                    "drums_separation.hance",
                    "piano_separation.hance",
                    "bass_separation.hance"];

let isIsolated = false;

function setIsolation(isolate) {
    isIsolated = isolate;
    const att = isIsolated ? -60 : 0;
    const modeText = isIsolated ? "Isolated" : "Mixed";
    document.getElementById("isolationMode").innerText = modeText;

    attenuationForStem(0, att);
    attenuationForStem(1, att);
    attenuationForStem(2, att);
    attenuationForStem(3, att);
}

function toggleIsolation() {
    isIsolated = !isIsolated;
    setIsolation(isIsolated);
}





</script>

<script type="text/javascript" src="HanceEngine.js"></script>

<!-- Buttons to load sounds -->
<button onClick="loadExample('sounds/Music Delta 80s Rock.mp3', 0)">Load song</button>

<button id="playbutton" onClick="playExample()" disabled>Play</button>
<button id="stopbutton" onClick="stop()" disabled>Stop</button>
<button id="isolationMode" onClick="toggleIsolation()">Mixed</button>
<button id="stemNum" onClick="connectToNextChannel()">Stem 0</button>

<table>
    <tr>
        <td>Steps</td>
    </tr>
    <tr>
        <td>Load Engine</td>
        <td id="loadengine"></td>
    </tr>
    <tr>
        <td>Add License</td>
        <td id="addlicense"></td>
    </tr>
    <tr>
        <td>Load Model</td>
        <td id="loadmodel">&#x1F550;</td>
    </tr>
    <tr>
        <td>Transfer Model</td>
        <td id="transfermodel">&#x1F550;</td>
    </tr>
    <tr>
        <td>Load Example</td>
        <td id="loadexample">&#x1F550;</td>
    </tr>
</table>
</body>
</html>
